name: "Dev: Sync .github folder across branches"

run-name: "Dev: Sync .github folder across branches"

on:
  workflow_dispatch:
    inputs:
      target_branches:
        description: 'Target branches to sync (comma-separated, leave empty for all branches)'
        required: false
        default: ''
      exclude_branch:
        description: 'Branches to exclude from sync (comma-separated)'
        required: false
        default: ''
      check_only:
        description: 'Check mode - show differences without syncing'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

jobs:
  sync-github-folder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get all branches
        id: get-branches
        run: |
          # Get all remote branches excluding main
          BRANCHES=$(git branch -r | grep -v "origin/main" | grep -v "HEAD" | sed 's/origin\///' | tr '\n' ',' | sed 's/,$//')
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "Available branches: $BRANCHES"

      - name: Parse target branches
        id: parse-targets
        run: |
          if [ -n "${{ github.event.inputs.target_branches }}" ]; then
            TARGET_BRANCHES="${{ github.event.inputs.target_branches }}"
          else
            TARGET_BRANCHES="${{ steps.get-branches.outputs.branches }}"
          fi
          
          # Process exclude branches
          EXCLUDE_BRANCHES="${{ github.event.inputs.exclude_branch }}"
          echo "exclude_branches=$EXCLUDE_BRANCHES" >> $GITHUB_OUTPUT
          echo "Exclude branches: $EXCLUDE_BRANCHES"
          
          echo "target_branches=$TARGET_BRANCHES" >> $GITHUB_OUTPUT
          echo "Target branches: $TARGET_BRANCHES"

      - name: Sync .github folder to each branch
        run: |
          set -e
          trap 'echo "Error occurred at line $LINENO"' ERR
          
          TARGET_BRANCHES="${{ steps.parse-targets.outputs.target_branches }}"
          EXCLUDE_BRANCHES="${{ steps.parse-targets.outputs.exclude_branches }}"
          CHECK_ONLY="${{ github.event.inputs.check_only }}"
          
          # Convert comma-separated string to array
          IFS=',' read -ra BRANCH_ARRAY <<< "$TARGET_BRANCHES"
          IFS=',' read -ra EXCLUDE_ARRAY <<< "$EXCLUDE_BRANCHES"
          
          # Create a filtered array excluding specified branches
          FILTERED_BRANCHES=()
          for branch in "${BRANCH_ARRAY[@]}"; do
            branch=$(echo "$branch" | xargs)  # Trim whitespace
            if [ -n "$branch" ]; then
              # Check if branch should be excluded
              EXCLUDED=false
              for exclude_branch in "${EXCLUDE_ARRAY[@]}"; do
                exclude_branch=$(echo "$exclude_branch" | xargs)  # Trim whitespace
                if [ "$branch" = "$exclude_branch" ]; then
                  EXCLUDED=true
                  break
                fi
              done
              
              if [ "$EXCLUDED" = false ]; then
                FILTERED_BRANCHES+=("$branch")
              else
                echo "üö´ Excluding branch: $branch"
              fi
            fi
          done
          
          echo "=========================================="
          echo "Starting process for ${#FILTERED_BRANCHES[@]} branch(es)"
          echo "Check only mode: $CHECK_ONLY"
          echo "Excluded branches: $EXCLUDE_BRANCHES"
          echo "=========================================="
          
          for branch in "${FILTERED_BRANCHES[@]}"; do
            echo ""
            echo "=========================================="
            if [ "$CHECK_ONLY" = "true" ]; then
              echo "üîç Checking branch: $branch"
            else
              echo "üîÑ Processing branch: $branch"
            fi
            echo "=========================================="
            
            # Check if branch exists
            if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "‚úÖ Branch $branch exists"
              
              # Get the latest commit hash for main branch
              MAIN_COMMIT=$(git rev-parse origin/main)
              echo "üìã Main branch commit: ${MAIN_COMMIT:0:8}"
              
              # Get the latest commit hash for target branch
              TARGET_COMMIT=$(git rev-parse "origin/$branch")
              echo "üìã Target branch commit: ${TARGET_COMMIT:0:8}"
              
              # Check if .github folder exists in target branch
              if git ls-tree -r --name-only "origin/$branch" | grep -q "^\.github/"; then
                echo "üìÅ .github folder exists in $branch"
                
                # Get the latest modification time of .github files in main
                MAIN_GITHUB_TIME=$(git log --format="%ct" --max-count=1 -- .github/ | head -1)
                
                # Get the latest modification time of .github files in target branch
                TARGET_GITHUB_TIME=$(git log --format="%ct" --max-count=1 "origin/$branch" -- .github/ | head -1)
                
                # Convert timestamps to readable format
                MAIN_GITHUB_DATE=$(date -d "@$MAIN_GITHUB_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "Unknown")
                TARGET_GITHUB_DATE=$(date -d "@$TARGET_GITHUB_TIME" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "Unknown")
                
                echo "üïê Main .github last modified: $MAIN_GITHUB_DATE (timestamp: $MAIN_GITHUB_TIME)"
                echo "üïê Target .github last modified: $TARGET_GITHUB_DATE (timestamp: $TARGET_GITHUB_TIME)"
                
                # Check if we should sync or just show differences
                if [ "$CHECK_ONLY" = "true" ]; then
                  echo "üîç Check mode - analyzing differences for $branch..."
                  
                  # Get list of .github files in main (excluding sync-github-folder.yml)
                  echo "üìã Analyzing .github files in main branch..."
                  MAIN_GITHUB_FILES=$(git ls-tree -r --name-only origin/main | grep "^\.github/" | grep -v "sync-github-folder.yml" | sort)
                  
                  # Get list of .github files in target branch
                  echo "üìã Analyzing .github files in $branch branch..."
                  TARGET_GITHUB_FILES=$(git ls-tree -r --name-only "origin/$branch" | grep "^\.github/" | sort)
                  
                  # Find files that exist in main but not in target
                  MISSING_FILES=$(comm -23 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  
                  # Find files that exist in target but not in main
                  EXTRA_FILES=$(comm -13 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  
                  # Check for content differences in common files
                  DIFFERENT_FILES=""
                  COMMON_FILES=$(comm -12 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  for file in $COMMON_FILES; do
                    if [ -n "$file" ] && ! git diff --quiet "origin/main:$file" "origin/$branch:$file" 2>/dev/null; then
                      DIFFERENT_FILES="$DIFFERENT_FILES $file"
                    fi
                  done
                  
                  # Report findings
                  if [ -z "$MISSING_FILES" ] && [ -z "$EXTRA_FILES" ] && [ -z "$DIFFERENT_FILES" ]; then
                    echo "‚úÖ Branch $branch is up to date with main"
                  else
                    if [ -n "$MISSING_FILES" ]; then
                      echo "üìÑ Files missing in $branch (would be added):"
                      echo "$MISSING_FILES" | sed 's/^/   - /'
                    fi
                    
                    if [ -n "$EXTRA_FILES" ]; then
                      echo "üìÑ Files in $branch not in main (would be removed):"
                      echo "$EXTRA_FILES" | sed 's/^/   - /'
                    fi
                    
                    if [ -n "$DIFFERENT_FILES" ]; then
                      echo "üìÑ Files with different content in $branch:"
                      echo "$DIFFERENT_FILES" | sed 's/^/   - /'
                    fi
                  fi
                  
                else
                  # Normal sync mode
                  if [ -z "$TARGET_GITHUB_TIME" ] || [ "$MAIN_GITHUB_TIME" -gt "$TARGET_GITHUB_TIME" ]; then
                    echo "üîÑ Syncing .github folder to $branch..."
                    
                    # Create a new branch from target branch
                    echo "üìù Creating temporary branch sync-github-$branch"
                    git checkout -b "sync-github-$branch" "origin/$branch"
                    
                    # Copy .github folder from main (excluding sync-github-folder.yml)
                    echo "üìã Copying .github folder from main (excluding sync-github-folder.yml)"
                    git checkout origin/main -- .github/
                    
                    # Remove sync-github-folder.yml if it exists in target branch
                    if [ -f ".github/workflows/sync-github-folder.yml" ]; then
                      echo "üóëÔ∏è  Removing sync-github-folder.yml from target branch"
                      git rm -f .github/workflows/sync-github-folder.yml
                    fi
                    
                    # Remove workflow files that don't exist in main
                    echo "üßπ Cleaning up workflow files not present in main..."
                    for workflow_file in .github/workflows/*.yml .github/workflows/*.yaml; do
                      if [ -f "$workflow_file" ]; then
                        workflow_name=$(basename "$workflow_file")
                        if ! git ls-tree -r --name-only origin/main | grep -q "^\.github/workflows/$workflow_name$"; then
                          echo "üóëÔ∏è  Removing workflow not in main: $workflow_name"
                          git rm -f "$workflow_file"
                        fi
                      fi
                    done
                    
                    # Check if there are any changes
                    if git diff --staged --quiet; then
                      echo "‚ÑπÔ∏è  No changes to sync for $branch"
                      git checkout main
                      git branch -D "sync-github-$branch"
                      echo "üßπ Cleaned up temporary branch"
                    else
                      # Show what files will be changed
                      echo "üìÑ Files to be updated:"
                      git diff --staged --name-only | sed 's/^/   - /'
                      
                      # Commit and push changes
                      echo "üíæ Committing changes..."
                      git config user.name "github-actions[bot]"
                      git config user.email "github-actions[bot]@users.noreply.github.com"
                      git commit -m "ci: sync .github folder from main branch"
                      
                      # Push to target branch
                      echo "üöÄ Pushing changes to $branch..."
                      git push origin "sync-github-$branch:$branch"
                      
                      # Cleanup
                      git checkout main
                      git branch -D "sync-github-$branch"
                      
                      echo "‚úÖ Successfully synced .github folder to $branch"
                    fi
                  else
                    echo "‚è≠Ô∏è  Skipping $branch - target branch .github files are newer or same age"
                    echo "   Main: $MAIN_GITHUB_DATE"
                    echo "   Target: $TARGET_GITHUB_DATE"
                  fi
                fi
              else
                echo "üìÅ .github folder doesn't exist in $branch"
                
                if [ "$CHECK_ONLY" = "true" ]; then
                  echo "üîç Check mode - .github folder doesn't exist in $branch"
                  echo "üìÑ Files that would be added from main:"
                  git ls-tree -r --name-only origin/main | grep "^\.github/" | grep -v "sync-github-folder.yml" | sed 's/^/   - /'
                else
                  echo "üìÅ Creating .github folder in $branch..."
                  
                  # Create a new branch from target branch
                  echo "üìù Creating temporary branch sync-github-$branch"
                  git checkout -b "sync-github-$branch" "origin/$branch"
                  
                  # Copy .github folder from main (excluding sync-github-folder.yml)
                  echo "üìã Copying .github folder from main (excluding sync-github-folder.yml)"
                  git checkout origin/main -- .github/
                  
                  # Remove sync-github-folder.yml if it exists in target branch
                  if [ -f ".github/workflows/sync-github-folder.yml" ]; then
                    echo "üóëÔ∏è  Removing sync-github-folder.yml from target branch"
                    git rm -f .github/workflows/sync-github-folder.yml
                  fi
                  
                  # Remove workflow files that don't exist in main
                  echo "üßπ Cleaning up workflow files not present in main..."
                  for workflow_file in .github/workflows/*.yml .github/workflows/*.yaml; do
                    if [ -f "$workflow_file" ]; then
                      workflow_name=$(basename "$workflow_file")
                      if ! git ls-tree -r --name-only origin/main | grep -q "^\.github/workflows/$workflow_name$"; then
                        echo "üóëÔ∏è  Removing workflow not in main: $workflow_name"
                        git rm -f "$workflow_file"
                      fi
                    fi
                  done
                  
                  # Show what files will be added
                  echo "üìÑ Files to be added:"
                  git diff --staged --name-only | sed 's/^/   - /'
                  
                  # Commit and push changes
                  echo "üíæ Committing changes..."
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git commit -m "ci: add .github folder from main branch"
                  
                  # Push to target branch
                  echo "üöÄ Pushing changes to $branch..."
                  git push origin "sync-github-$branch:$branch"
                  
                  # Cleanup
                  git checkout main
                  git branch -D "sync-github-$branch"
                  
                  echo "‚úÖ Successfully created .github folder in $branch"
                fi
              fi
            else
              echo "‚ùå Branch $branch does not exist, skipping..."
            fi
            
            echo "=========================================="
            if [ "$CHECK_ONLY" = "true" ]; then
              echo "Finished checking branch: $branch"
            else
              echo "Finished processing branch: $branch"
            fi
            echo "=========================================="
          done
          
          echo ""
          echo "=========================================="
          if [ "$CHECK_ONLY" = "true" ]; then
            echo "üéâ Check process completed!"
            
            # Create summary for check mode
            echo "## üìä GitHub Folder Sync Check Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Mode:** Check Only (No changes made)" >> $GITHUB_STEP_SUMMARY
            echo "**Branches processed:** ${#FILTERED_BRANCHES[@]}" >> $GITHUB_STEP_SUMMARY
            if [ -n "$EXCLUDE_BRANCHES" ]; then
              echo "**Excluded branches:** $EXCLUDE_BRANCHES" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Initialize summary variables
            echo "üîç Initializing summary variables..."
            TOTAL_BRANCHES=${#FILTERED_BRANCHES[@]}
            UP_TO_DATE_BRANCHES=0
            BRANCHES_WITH_DIFFERENCES=0
            BRANCHES_WITHOUT_GITHUB=0
            echo "üîç Total branches to process: $TOTAL_BRANCHES"
            
            # Process each branch for summary
            echo "üîç Processing summary for ${#FILTERED_BRANCHES[@]} branches..."
            for branch in "${FILTERED_BRANCHES[@]}"; do
              echo "üîç Processing summary for branch: $branch"
              if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
                echo "  ‚úÖ Branch exists"
                if git ls-tree -r --name-only "origin/$branch" | grep -q "^\.github/"; then
                  echo "  üìÅ .github folder exists"
                  # Get list of .github files in main (excluding sync-github-folder.yml)
                  MAIN_GITHUB_FILES=$(git ls-tree -r --name-only origin/main | grep "^\.github/" | grep -v "sync-github-folder.yml" | sort)
                  MAIN_COUNT=$(echo "$MAIN_GITHUB_FILES" | wc -l 2>/dev/null || echo "0")
                  echo "  üìã Main files count: $MAIN_COUNT"
                  
                  # Get list of .github files in target branch
                  TARGET_GITHUB_FILES=$(git ls-tree -r --name-only "origin/$branch" | grep "^\.github/" | sort)
                  TARGET_COUNT=$(echo "$TARGET_GITHUB_FILES" | wc -l 2>/dev/null || echo "0")
                  echo "  üìã Target files count: $TARGET_COUNT"
                  
                  # Find differences
                  MISSING_FILES=$(comm -23 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  EXTRA_FILES=$(comm -13 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  
                  # Check for content differences in common files
                  DIFFERENT_FILES=""
                  COMMON_FILES=$(comm -12 <(echo "$MAIN_GITHUB_FILES") <(echo "$TARGET_GITHUB_FILES") 2>/dev/null || echo "")
                  COMMON_COUNT=$(echo "$COMMON_FILES" | wc -w 2>/dev/null || echo "0")
                  echo "  üîç Common files count: $COMMON_COUNT"
                  
                  for file in $COMMON_FILES; do
                    if [ -n "$file" ]; then
                      echo "  üîç Checking file: $file"
                      if git diff --quiet "origin/main:$file" "origin/$branch:$file" 2>/dev/null; then
                        echo "  ‚úÖ File is identical: $file"
                      else
                        echo "  ‚ö†Ô∏è  File differs: $file"
                        DIFFERENT_FILES="$DIFFERENT_FILES $file"
                      fi
                    fi
                  done
                  
                     # Add to summary
                     echo "  üîç Summary: Missing=$MISSING_FILES, Extra=$EXTRA_FILES, Different=$DIFFERENT_FILES"
                     if [ -z "$MISSING_FILES" ] && [ -z "$EXTRA_FILES" ] && [ -z "$DIFFERENT_FILES" ]; then
                       UP_TO_DATE_BRANCHES=$((UP_TO_DATE_BRANCHES + 1))
                       echo "  ‚úÖ Added to summary: Up to date"
                     else
                       # –ù–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–µ—Ç–∫–∏ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º
                       echo "#### $branch" >> $GITHUB_STEP_SUMMARY
                       echo "---" >> $GITHUB_STEP_SUMMARY
                       
                       if [ -n "$MISSING_FILES" ]; then
                         MISSING_COUNT=$(echo "$MISSING_FILES" | wc -l 2>/dev/null || echo "0")
                         echo "**Missing files:** $MISSING_COUNT" >> $GITHUB_STEP_SUMMARY
                         echo "$MISSING_FILES" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
                         echo "  üìÑ Missing files count: $MISSING_COUNT"
                       fi
                       
                       if [ -n "$EXTRA_FILES" ]; then
                         EXTRA_COUNT=$(echo "$EXTRA_FILES" | wc -l 2>/dev/null || echo "0")
                         echo "**Extra files:** $EXTRA_COUNT" >> $GITHUB_STEP_SUMMARY
                         echo "$EXTRA_FILES" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
                         echo "  üìÑ Extra files count: $EXTRA_COUNT"
                       fi
                       
                       if [ -n "$DIFFERENT_FILES" ]; then
                         DIFFERENT_COUNT=$(echo "$DIFFERENT_FILES" | wc -w 2>/dev/null || echo "0")
                         echo "**Different content:** $DIFFERENT_COUNT" >> $GITHUB_STEP_SUMMARY
                         echo "$DIFFERENT_FILES" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
                         echo "  üìÑ Different files count: $DIFFERENT_COUNT"
                       fi
                       
                       BRANCHES_WITH_DIFFERENCES=$((BRANCHES_WITH_DIFFERENCES + 1))
                       echo "  ‚ö†Ô∏è  Added to summary: Has differences"
                       echo "" >> $GITHUB_STEP_SUMMARY
                     fi
                                 else
                   # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤–µ—Ç–æ–∫ –±–µ–∑ .github
                   echo "#### $branch" >> $GITHUB_STEP_SUMMARY
                   echo "---" >> $GITHUB_STEP_SUMMARY
                   echo "**No .github folder**" >> $GITHUB_STEP_SUMMARY
                   BRANCHES_WITHOUT_GITHUB=$((BRANCHES_WITHOUT_GITHUB + 1))
                   echo "  üìÅ Added to summary: No .github folder"
                   echo "" >> $GITHUB_STEP_SUMMARY
                 fi
              else
                echo "  ‚ùå Branch does not exist: $branch"
              fi
            done
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìà Summary Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total branches:** $TOTAL_BRANCHES" >> $GITHUB_STEP_SUMMARY
            echo "- **Up to date:** $UP_TO_DATE_BRANCHES" >> $GITHUB_STEP_SUMMARY
            echo "- **With differences:** $BRANCHES_WITH_DIFFERENCES" >> $GITHUB_STEP_SUMMARY
            echo "- **Without .github folder:** $BRANCHES_WITHOUT_GITHUB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Branches with Differences" >> $GITHUB_STEP_SUMMARY
            echo "Only branches with differences are shown in the summary above."
            
            echo "üîç Summary statistics:"
            echo "  - Total branches: $TOTAL_BRANCHES"
            echo "  - Up to date: $UP_TO_DATE_BRANCHES"
            echo "  - With differences: $BRANCHES_WITH_DIFFERENCES"
            echo "  - Without .github folder: $BRANCHES_WITHOUT_GITHUB"
            echo "üîç Summary creation completed successfully!"
            
          else
            echo "üéâ Sync process completed!"
            
            # Create summary for sync mode
            echo "## üîÑ GitHub Folder Sync Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Mode:** Sync (Changes applied)" >> $GITHUB_STEP_SUMMARY
            echo "**Branches processed:** ${#FILTERED_BRANCHES[@]}" >> $GITHUB_STEP_SUMMARY
            if [ -n "$EXCLUDE_BRANCHES" ]; then
              echo "**Excluded branches:** $EXCLUDE_BRANCHES" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Note: Detailed sync results are shown in the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "==========================================" 
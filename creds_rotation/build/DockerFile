FROM python:3.12-alpine

USER root

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# Copy files first to leverage Docker layer caching
COPY creds_rotation/build/pip.conf /etc/pip.conf
COPY creds_rotation/build/requirements.txt /build/requirements.txt
COPY creds_rotation/scripts /module/scripts
COPY python /python
COPY scripts /build_env/scripts

# Only install minimal build tools temporarily (if needed)
RUN apk add --no-cache --virtual .build-deps \
        gcc \
        musl-dev \
        libffi-dev \
        python3-dev \
        curl \
    && curl --retry 3 --retry-connrefused --retry-delay 5 -LO https://github.com/mozilla/sops/releases/download/v3.9.0/sops-v3.9.0.linux.amd64 \
    && chmod +x sops-v3.9.0.linux.amd64 && mv sops-v3.9.0.linux.amd64 /usr/local/bin/sops \
    && pip install --no-cache-dir --no-deps -r /build/requirements.txt \
    && pip install --no-cache-dir /python/envgene \
    && pip install --no-cache-dir /python/jschon-sort \
    && apk del .build-deps \
    && rm -rf /var/cache/apk/* /tmp/* /var/tmp/* /root/.cache /build /python/*.egg-info


##################################

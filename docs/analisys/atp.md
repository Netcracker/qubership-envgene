# QTP Parameter Management

- [QTP Parameter Management](#qtp-parameter-management)
  - [Terms](#terms)
  - [Problem Statement](#problem-statement)
  - [Requirements](#requirements)
  - [Use Cases](#use-cases)
  - [Proposed Approach](#proposed-approach)
    - [Object Model](#object-model)
    - [Option 1. QTP-specific parameters Discovery](#option-1-qtp-specific-parameters-discovery)
      - [Testing context](#testing-context)
      - [Testing parameters discovery](#testing-parameters-discovery)
  - [Open Questions](#open-questions)

## Terms

**Effective Set** - A structured set of configuration parameters generated by EnvGene for a specific consumer (in this case - QTP)  
**Testing context of Effective Set** - the portion of the Effective Set that includes parameters specific to QTP  
**Template Repository** - Contains common parameters for all solution instances  
**Instance Repository** - Contains environment-specific parameters for a particular instance  

## Problem Statement

QTP as a system that tests Customer's Environments (Solution Instances) requires parameters related to these Environments and their supporting infrastructure.

Maintaining duplicate copies of these parameters across different configuration management (CM) systems:

- Additional CM overhead
- Increases operational costs through redundant effort
- Introduces risks of:
  - Human errors in configuration
  - Configuration drift (when identical parameters become desynchronized across CMs)

## Requirements

1. The QA engineer should not enter parameter values for the testing context.
2. QTP must be able to retrieve the QTP context within 5 seconds.
3. Generation of QTP-specific context must modify only this context without affecting other Effective Set contexts

## Use Cases

List of use cases that need to be supported:

1. Onboarding QTP into existing Customer's EnvGene repositories
2. Generation of QTP-specific parameter set (Effective Set)
   1. Without encryption of sensitive parameters
   2. With encryption of sensitive parameters
3. Adding/Modifying/Removing parameters in QTP-specific parameter set (Effective Set)
   1. Parameters defined exclusively by QTP QA team
   2. Parameters defined by Customer's team
4. Cluster Creation

## Proposed Approach

Since EnvGene repositories contain:

- Inventory of Customer's Environments
- Parameters describing Customer's Solution Instances
- Parameters describing Cloud/clusters

It is proposed to use EnvGene to generate QTP-required parameters based on both:

- Customer-defined parameters
- QA team-maintained QTP-specific parameters

### Object Model

![Object Model](QTP-envgene-model.drawio.png)

### Option 1. QTP-specific parameters Discovery

1. QTP-specific parameters are generated by EnvGene as [testing context](#testing-context) of [Effective Set](https://github.com/Netcracker/qubership-envgene/blob/feature/es_impovement_step_2/docs/calculator-cli.md#version-20-effective-set-structure)
2. QTP retrieves Effective Set for a specific Environment via contract path from Customer's Instance repository
3. QTP retrieves the latest of Effective Set
4. Values for QTP-specific parameters are [auto-discovered](#testing-parameters-discovery)
5. The discovery procedure occurs when:
   1. Creating a business environment
   2. Changing the composition of tested applications/systems in the business environment
   3. After credential rotation if it affects systems (in terms of QTP)

![Option 1. QTP-specific parameters Discovery](/docs/images/QTP-option-1.drawio.png)

#### Testing context

It is proposed to introduce a testing context of the Effective Set, which includes a file containing both sensitive and non-sensitive parameters.

```yaml
---
# parameters.yaml
<qtp-system-name>:
  type: enum[cluster|cloudApplication], Mandatory # System type
  connections:
    <clusterAPI|DB|applicationUI|applicationAPI>: # Connection type
      host: string, Optional # For `DB` connection type
      port: number, Optional # For `DB` connection type
      dbName: string, Optional # For `DB` connection type
      url: string, Optional # For `applicationUI` connection type
      apiUrl: string, Optional # For `clusterAPI`, `applicationAPI` connection types
---
# credentials.yaml
<qtp-system-name>:
  type: enum[cluster|cloudApplication], Mandatory # System type
  connections:
    <clusterAPI|DB|applicationUI|applicationAPI>: # Connection type
      login: string, Optional # For `DB`, `applicationUI` connection type
      password: string, Optional
      token: string, Optional
```

#### Testing parameters discovery

It is proposed automated discovery testing context parameters. For discovery purposes develop and utilize a testing parameters discovery CLI tool.

The CLI will be executed during the GitLab pipeline run in the EnvGene Discovery repository.

The EnvGene Instance repository integrates with the Discovery repository, enabling it to receive testing parameters and generate the Effective Set testing context based on them.

The CLI will accept the following inputs:

1. A kubconfig with necessary permissions (RO) in business application namespaces to access to the cluster
2. DBaaS API endpoint and credentials
3. An application-to-microservice mapping configuration file:

    ```yaml
    businessApplicationNamespaces:
      <namespace-name>:
        <application-name>:
          UIservice: <service-name>
          APIservice: <service-name>
          DBservice: <service-name>
    SANamespace: <namespace-name>
    ```

The discovery process will interact with cluster API and DBaaS API to collect the following parameters:

1. `host`, `port`, `dbName`, `login`, `password` from the `DBservice`'s database

    For discovering these parameters, we propose using DBaaS API which allows retrieving connection details (containing all required parameters) when provided with a service name and namespace

2. `token` from the cluster service account

    Expects an SA with a contract name in the `SANamespace` namespace with necessary permissions

3. `url`, `apiUrl`, `login`, `password`

    - `url` is generated based on an ingress searched in the corresponding namespace using a pattern that includes the `UIservice` name OR generated by the discovery tool using the pattern `<service-name>-<namespace>-<cluster-host>`
    - `apiUrl` is generated using the pattern **~** `<gateway-url>`/`<APIservice-identifier>`
    - `login` and `password` are searched in the corresponding namespace using a pattern that includes the `UIservice` and `APIservice` names

The results will be saved in QTP parameters format.

1. A kubeconfig with SA with required read-only (RO) permissions in `businessApplicationNamespaces` and `SANamespace` namespaces
2. DBaaS API endpoint and credentials
3. Application-to-microservice mapping configuration file:

    ```yaml
    businessApplicationNamespaces:
      <namespace-name>:
        <application-name>:
          UIservice: <service-name>
          APIservice: <service-name>
          DBservice: <service-name>
    SANamespace: <namespace-name>
    ```

## Open Questions

1. What should the model for QTP-specific context in Effective Set look like?
   1. A: [testing context](#testing-context)
2. How to split QA team-maintained QTP-specific parameters between Template and Instance repositories?
   1. А: All testing context parameters are env-specific and will reside in the instance repository
3. Are parameters in Customer's repository sufficient for QTP parameter generation?
   1. А: Parameters in Customer's repository are insufficient - we need to implement a discovery procedure
4. How to ensure Requirement 1 is met?
5. Do business applications have labels that allow UI/API service identification?
6. Should we generate URLs or discover them through ingress?
7. What's the URL formation principle when accessing business app API through gateway?
8. In which cases do we use public vs private gateway?
9. Is the discovery procedure on the site secure?
10. What token permissions are required for discovery?
11. What's the naming convention for service credential secrets? Is it application-specific?
12. What authentication method is used for business applications' APIs?
    1. Does QTP context contain login/password that QTP uses to obtain tokens?

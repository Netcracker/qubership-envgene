
# Environments Structure

- [Environments Structure](#environments-structure)
  - [Problem Statement](#problem-statement)
  - [Requirements](#requirements)
  - [Proposed Approach](#proposed-approach)

## Problem Statement

The EnvGene Instance repository keeps information about:

- Site structure: which Environments exist in the site
- Environment structure: which namespaces are in each Environment and what roles (deployPostfix) they have

External systems need this information, for example, to show a list of available Environments in a UI so a user can start operations on them.

EnvGene is the main source of this information and must provide it.

Getting this information should not require specifying a particular Environment name.

## Requirements

1. Environments Structure generation operation must complete within 1 second (excluding GitLab/GitHub runner span time) for a repository with:
   1. 50 clusters
   2. 10 environments in each cluster
   3. 5 namespaces in each environment
2. The Environments Structure generation job logs must clearly show how long the job took

## Proposed Approach

The Instance repository contains the Environments Structure. The Environments Structure object describes all Environments in the site (Instance repository). For each Environment, it lists the namespaces, and for each namespace, it shows the deploy postfix.

The Environments Structure is stored in Instance repository at `/environments/environment-structure.yml`.

The Environments Structure is generated by the [Instance on-commit pipeline](/docs/envgene-pipelines.md). This pipeline runs automatically on every push to the remote repository. It does not require any extra actions from the user or external systems, and does not need extra configuration.

During this pipeline, the generated object is saved by committing it to the Instance repository. On each new generation, the previous Environments Structure is replaced with the new one.

> [!NOTE]
> Due to the fact that the [Instance on-commit pipeline](/docs/envgene-pipelines.md) also commits to the repository,
> a prerequisite for its operation is a specified [``]() variable
> that contains an access token to the Instance repository.

For each Environment in the repository, the Environments Structure lists the namespaces and, for each namespace, the deploy postfix.

- The namespace name is taken from the `name` attribute of the Namespace object in the Environment Instance.
- The deploy postfix is taken from the namespace folder name in the Environment Instance.

The structure of the object is as follows (each field is mandatory):

```yaml
environments:
  <cluster-name>/<environment-name>:
    namespaces:
      <namespace-name>:
        deployPostfix: <deploy-postfix>
```

Example:

```yaml
environments:
  cluster-01/env-1:
    namespaces:
      env-1-core:
        deployPostfix: core
      env-1-bss:
        deployPostfix: bss
  cluster-01/env-2:
    namespaces:
      env-2-core:
        deployPostfix: core
      env-2-bss:
        deployPostfix: bss
  cluster-02/env-1:
    namespaces:
      core:
        deployPostfix: core
      oss:
        deployPostfix: oss
```

> [!NOTE]
> Within the Instance repository, `<cluster-name>/<environment-name>` is a unique Environment ID.
> Within a single Environment, the namespace name is unique
